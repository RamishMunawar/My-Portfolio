<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Test</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ffffff">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .pass { background: #d4edda; }
        .fail { background: #f8d7da; }
    </style>
</head>
<body>
    <h1>PWA Install Test</h1>
    <div id="tests"></div>
    
    <script>
        const tests = document.getElementById('tests');
        
        function addTest(name, passed, message) {
            const div = document.createElement('div');
            div.className = `test ${passed ? 'pass' : 'fail'}`;
            div.innerHTML = `<strong>${name}:</strong> ${passed ? 'PASS' : 'FAIL'} - ${message}`;
            tests.appendChild(div);
        }
        
        // Test 1: Service Worker Support
        if ('serviceWorker' in navigator) {
            addTest('Service Worker Support', true, 'Browser supports service workers');
        } else {
            addTest('Service Worker Support', false, 'Browser does not support service workers');
        }
        
        // Test 2: HTTPS
        if (location.protocol === 'https:' || location.hostname === 'localhost') {
            addTest('HTTPS/Localhost', true, 'Running on HTTPS or localhost');
        } else {
            addTest('HTTPS/Localhost', false, 'Not running on HTTPS (required for PWA)');
        }
        
        // Test 3: Manifest
        fetch('/manifest.json')
            .then(response => response.json())
            .then(manifest => {
                addTest('Manifest', true, 'Manifest loaded successfully');
                
                // Test 4: Required manifest fields
                const required = ['name', 'short_name', 'start_url', 'display', 'icons'];
                const missing = required.filter(field => !manifest[field]);
                if (missing.length === 0) {
                    addTest('Manifest Fields', true, 'All required fields present');
                } else {
                    addTest('Manifest Fields', false, `Missing: ${missing.join(', ')}`);
                }
                
                // Test 5: Icons
                if (manifest.icons && manifest.icons.length > 0) {
                    const has192 = manifest.icons.some(icon => icon.sizes.includes('192'));
                    const has512 = manifest.icons.some(icon => icon.sizes.includes('512'));
                    if (has192 && has512) {
                        addTest('Icons', true, 'Has 192x192 and 512x512 icons');
                    } else {
                        addTest('Icons', false, 'Missing required icon sizes');
                    }
                } else {
                    addTest('Icons', false, 'No icons defined');
                }
            })
            .catch(() => {
                addTest('Manifest', false, 'Failed to load manifest');
            });
        
        // Test 6: Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    addTest('Service Worker Registration', true, 'Service worker registered successfully');
                })
                .catch(error => {
                    addTest('Service Worker Registration', false, `Failed to register: ${error.message}`);
                });
        }
        
        // Test 7: Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            addTest('Install Prompt', true, 'Install prompt event fired - PWA is installable!');
            
            // Show install button
            const installBtn = document.createElement('button');
            installBtn.textContent = 'Install App';
            installBtn.style.cssText = 'padding: 10px 20px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 10px 0;';
            installBtn.onclick = () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        addTest('Install Result', true, 'User accepted installation');
                    } else {
                        addTest('Install Result', false, 'User dismissed installation');
                    }
                    deferredPrompt = null;
                });
            };
            tests.appendChild(installBtn);
        });
        
        // Test 8: Already Installed
        window.addEventListener('appinstalled', () => {
            addTest('App Installed', true, 'PWA was successfully installed!');
        });
        
        // Check if already installed
        if (window.matchMedia('(display-mode: standalone)').matches) {
            addTest('Already Installed', true, 'App is already installed and running in standalone mode');
        }
    </script>
</body>
</html>
